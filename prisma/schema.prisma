generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Question {
  id             String   @id @default(uuid())
  text           String
  type           QuestionType
  ownerId        String?  // Optional for now to support public questions
  owner          User?    @relation(fields: [ownerId], references: [id])
  
  quizId         String?
  quiz           Quiz?    @relation(fields: [quizId], references: [id], onDelete: Cascade)

  options        String[] // Array of answer options
  correctAnswer  String
  points         Int      @default(100)
  negativePoints Int      @default(25)
  timeLimit      Int      @default(30) // seconds
  round          Int      @default(1)
  imageUrl       String?  // Image for the question
  optionImages   String[] // Images for options (MCQ/Buzzer)
  readingTime    Int      @default(0)  // Seconds to wait before buzzer activates
  musicFile      String?
  category       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  sessions       SessionQuestion[]
  answers        Answer[]
}

enum QuestionType {
  MULTIPLE_CHOICE
  BUZZER
  TRUE_FALSE
  SHORT_ANSWER
}

model Quiz {
  id          String     @id @default(uuid())
  title       String
  description String?
  ownerId     String
  owner       User       @relation(fields: [ownerId], references: [id])
  questions   Question[]
  sessions    Session[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  
  quizzes     Quiz[]
  questions   Question[]
  sessions    Session[]
  musicTracks MusicTrack[]
}

model Session {
  id                   String   @id @default(uuid())
  code                 String   @unique // e.g., "ABC-123"
  hostId               String
  host                 User     @relation(fields: [hostId], references: [id])

  quizId               String?
  quiz                 Quiz?    @relation(fields: [quizId], references: [id])

  currentQuestionIndex Int      @default(0)
  status               SessionStatus @default(WAITING)
  musicEnabled         Boolean  @default(true)
  musicVolume          Float    @default(0.5)
  showLiveResults      Boolean  @default(true)
  allowLateJoin        Boolean  @default(false)
  createdAt            DateTime @default(now())
  completedAt          DateTime?
  
  // Relations
  questions            SessionQuestion[]
  participants         Participant[]
  analytics            Analytics?
}

enum SessionStatus {
  WAITING
  ACTIVE
  PAUSED
  COMPLETED
}

enum MusicTrackType {
  QUESTION
  OPTIONS
  ANSWER
  ROUND_RESULTS
  FINAL_RESULTS
}

model MusicTrack {
  id        String         @id @default(uuid())
  type      MusicTrackType
  filename  String
  url       String
  ownerId   String
  owner     User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  
  @@unique([ownerId, type])
}

model SessionQuestion {
  id         String   @id @default(uuid())
  sessionId  String
  questionId String
  order      Int
  
  session    Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id])
  
  @@unique([sessionId, order])
}

model Participant {
  id          String   @id @default(uuid())
  sessionId   String
  name        String
  score       Int      @default(0)
  buzzerWins  Int      @default(0)
  joinedAt    DateTime @default(now())
  
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  answers     Answer[]
  
  @@unique([sessionId, name])
}

model Answer {
  id            String   @id @default(uuid())
  participantId String
  questionId    String
  answer        String
  isCorrect     Boolean
  points        Int
  timeToAnswer  Int?     // milliseconds
  timestamp     DateTime @default(now())
  
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  question      Question    @relation(fields: [questionId], references: [id])
  
  @@unique([participantId, questionId])
}

model Analytics {
  id                 String   @id @default(uuid())
  sessionId          String   @unique
  totalStudents      Int
  averageScore       Float
  questionStats      Json     // Flexible JSON for question-level stats
  topPerformers      Json     // Array of top performers
  detailedResults    Json?    // NEW: All participant results grouped by round
  scoreDistribution  Json     // Score ranges and counts
  buzzerStats        Json     // Buzzer-specific analytics
  createdAt          DateTime @default(now())
  
  session            Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}
